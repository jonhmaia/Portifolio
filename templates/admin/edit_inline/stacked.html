{% load i18n admin_urls static admin_modify %}

<div class="inline-group" id="{{ inline_admin_formset.formset.prefix }}-group">
    <div class="module">
        <h2>{{ inline_admin_formset.opts.verbose_name_plural|capfirst }}</h2>
        
        <div class="inline-forms">
            {{ inline_admin_formset.formset.management_form }}
            
            {% for inline_admin_form in inline_admin_formset %}
                <div class="inline-form{% if inline_admin_form.original %} has_original{% endif %}">
                    {% if inline_admin_form.form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ inline_admin_form.form.non_field_errors }}
                        </div>
                    {% endif %}
                    
                    {% if inline_admin_form.original %}
                        <h3 class="inline-form-title">
                            <i class="fas fa-edit me-2"></i>
                            {{ inline_admin_formset.opts.verbose_name|capfirst }}: {{ inline_admin_form.original }}
                        </h3>
                    {% else %}
                        <h3 class="inline-form-title">
                            <i class="fas fa-plus me-2"></i>
                            Novo {{ inline_admin_formset.opts.verbose_name|capfirst }}
                        </h3>
                    {% endif %}
                    
                    {% if inline_admin_form.show_url %}
                        <div class="inline-form-actions">
                            <a href="{{ inline_admin_form.absolute_url }}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-external-link-alt me-1"></i>
                                Ver
                            </a>
                        </div>
                    {% endif %}
                    
                    {% for fieldset in inline_admin_form %}
                        <fieldset class="inline-fieldset">
                            {% if fieldset.name %}
                                <legend>{{ fieldset.name }}</legend>
                            {% endif %}
                            
                            {% for line in fieldset %}
                                <div class="form-row{% if line.fields|length_is:'1' and line.errors %} errors{% endif %}">
                                    {% for field in line %}
                                        <div class="field-box{% if not line.fields|length_is:'1' %} field-{{ field.field.name }}{% endif %}">
                                            {% if field.is_checkbox %}
                                                <div class="checkbox-row">
                                                    {{ field.field }}
                                                    {{ field.label_tag }}
                                                </div>
                                            {% else %}
                                                {{ field.label_tag }}
                                                
                                                {% if field.field.field.widget.input_type == 'file' %}
                                                    <div class="file-upload">
                                                        {{ field.field }}
                                                        <label class="file-upload-label" for="{{ field.field.id_for_label }}">
                                                            <div class="file-upload-icon">
                                                                <i class="fas fa-cloud-upload-alt"></i>
                                                            </div>
                                                            <div>Clique para selecionar um arquivo</div>
                                                            <small class="text-muted">Formatos aceitos: JPG, PNG, GIF</small>
                                                        </label>
                                                    </div>
                                                    
                                                    {% if field.field.value %}
                                                        <div class="currently">
                                                            <strong>Arquivo atual:</strong> 
                                                            <a href="{{ field.field.value.url }}" target="_blank">{{ field.field.value.name }}</a>
                                                        </div>
                                                    {% endif %}
                                                {% else %}
                                                    {{ field.field }}
                                                {% endif %}
                                            {% endif %}
                                            
                                            {% if field.field.help_text %}
                                                <div class="help">{{ field.field.help_text|safe }}</div>
                                            {% endif %}
                                            
                                            {{ field.field.errors }}
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endfor %}
                        </fieldset>
                    {% endfor %}
                    
                    {% if inline_admin_form.needs_explicit_pk_field %}
                        {{ inline_admin_form.pk_field.field }}
                    {% endif %}
                    
                    {% if inline_admin_form.fk_field %}
                        {{ inline_admin_form.fk_field.field }}
                    {% endif %}
                    
                    {% if inline_admin_formset.can_delete and inline_admin_form.original %}
                        <div class="delete-row">
                            <div class="checkbox-row">
                                {{ inline_admin_form.deletion_field.field }}
                                <label for="{{ inline_admin_form.deletion_field.field.id_for_label }}" class="delete-label">
                                    <i class="fas fa-trash me-1"></i>
                                    Marcar para exclusão
                                </label>
                            </div>
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
        
        {% if inline_admin_formset.can_add %}
            <div class="add-row">
                <a href="javascript:void(0)" class="add-another" onclick="addInlineForm('{{ inline_admin_formset.formset.prefix }}')">
                    <i class="fas fa-plus me-2"></i>
                    Adicionar outro {{ inline_admin_formset.opts.verbose_name }}
                </a>
            </div>
        {% endif %}
    </div>
</div>

<style>
.inline-group {
    margin-bottom: 2rem;
}

.inline-form {
    background: #f8fafc;
    border: 1px solid var(--border-color);
    border-radius: 0.5rem;
    margin-bottom: 1rem;
    padding: 1.5rem;
    position: relative;
}

.inline-form-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0 0 1rem 0;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border-color);
}

.inline-form-actions {
    position: absolute;
    top: 1rem;
    right: 1rem;
}

.inline-fieldset {
    border: none;
    padding: 0;
    margin: 0;
}

.inline-fieldset legend {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 1rem;
    padding: 0;
    border: none;
}

.delete-row {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border-color);
}

.delete-label {
    color: var(--danger-color);
    font-weight: 500;
}

.add-another {
    color: var(--success-color);
    text-decoration: none;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    padding: 0.5rem 1rem;
    border: 1px solid var(--success-color);
    border-radius: 0.375rem;
    transition: all 0.2s ease;
}

.add-another:hover {
    background-color: var(--success-color);
    color: white;
    text-decoration: none;
}

.inline-forms {
    max-height: 600px;
    overflow-y: auto;
    padding-right: 0.5rem;
}

.inline-forms::-webkit-scrollbar {
    width: 6px;
}

.inline-forms::-webkit-scrollbar-track {
    background: var(--light-bg);
    border-radius: 3px;
}

.inline-forms::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 3px;
}

.inline-forms::-webkit-scrollbar-thumb:hover {
    background: var(--text-secondary);
}
</style>

<script>
function addInlineForm(prefix) {
    const totalForms = document.getElementById('id_' + prefix + '-TOTAL_FORMS');
    const formCount = parseInt(totalForms.value);
    const newForm = document.querySelector('#' + prefix + '-group .inline-form').cloneNode(true);
    
    // Atualizar IDs e nomes dos campos
    const formRegex = new RegExp(prefix + '-(\\d+)-', 'g');
    newForm.innerHTML = newForm.innerHTML.replace(formRegex, prefix + '-' + formCount + '-');
    
    // Limpar valores dos campos
    const inputs = newForm.querySelectorAll('input, select, textarea');
    inputs.forEach(function(input) {
        if (input.type !== 'hidden') {
            input.value = '';
            input.checked = false;
        }
    });
    
    // Adicionar o novo formulário
    const formsContainer = document.querySelector('#' + prefix + '-group .inline-forms');
    formsContainer.appendChild(newForm);
    
    // Atualizar contador
    totalForms.value = formCount + 1;
    
    // Scroll para o novo formulário
    newForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
}
</script>